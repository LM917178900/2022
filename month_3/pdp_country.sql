with base_v0 AS ( SELECT a.geo, a.subgeo, a.country, a.product_group, a.brand, a.product_name, a.product AS sm_number, d.item_short_description AS sm_description, a.bucket, a.source_code, a.site_id, b.factory, a.pdp_init, a.pdp_final, a.version, a.update_timestamp, a.seller, a.demand_type, a.color, a.mram, a.mrom, a.design_category, a.subbrand, a.batch_number, a.xcvr, a.pss_version, e.id AS npi_product_id, e.npi_product_name FROM (((ludp_pdp a JOIN ( SELECT dim_product_mapping.id, dim_product_mapping.npi_product_name, dim_product_mapping.product_name_in_sci_pdp FROM dim_product_mapping WHERE ((dim_product_mapping.product_name_in_sci_pdp)::text != ''::text and npi_product_name='DEVON22' ) GROUP BY dim_product_mapping.id, dim_product_mapping.npi_product_name, dim_product_mapping.product_name_in_sci_pdp) e ON (((a.product_name)::text = (e.product_name_in_sci_pdp)::text))) LEFT JOIN ( SELECT DISTINCT dim_factory_mapping.factory, dim_factory_mapping.site_id FROM dim_factory_mapping) b ON (((a.site_id)::text = (b.site_id)::text))) LEFT JOIN ludp_windchill_product_item d ON (((a.product)::text = (d.item_number)::text))) WHERE 1=1 and a.version='20220221' ), base_v1 AS ( SELECT a.geo, a.subgeo, a.country, a.product_group, a.brand, a.product_name, a.sm_number, a.sm_description, a.bucket, a.source_code, a.site_id, a.factory, a.pdp_init, a.pdp_final, a.version, a.update_timestamp, a.seller, a.demand_type, a.color, a.mram, a.mrom, a.design_category, a.subbrand, a.batch_number, a.xcvr, a.pss_version, c.npi_product_id, c.npi_product, c.npi_country, c.npi_region, c.npi_customer, c.npi_color FROM (base_v0 a JOIN ( SELECT DISTINCT datahub_customer_mapping_pdp.npi_product_id, datahub_customer_mapping_pdp.npi_product, datahub_customer_mapping_pdp.npi_country, datahub_customer_mapping_pdp.npi_region, datahub_customer_mapping_pdp.npi_customer, datahub_customer_mapping_pdp.npi_color, datahub_customer_mapping_pdp.pdp_product_name, datahub_customer_mapping_pdp.pdp_country_code, datahub_customer_mapping_pdp.pdp_color, datahub_customer_mapping_pdp.pdp_sm_number FROM datahub_customer_mapping_pdp where 1=1 ) c ON ((((a.product_name)::text = (c.pdp_product_name)::text) AND ((a.country)::text = (c.pdp_country_code)::text) AND ((a.color)::text = (c.pdp_color)::text) AND ((a.sm_number)::text = (c.pdp_sm_number)::text) AND ((a.npi_product_id)::text = (c.npi_product_id)::text)))) ), filter_v1 AS ( SELECT base_v1.npi_product_id, base_v1.npi_product, base_v1.country FROM base_v1 WHERE (base_v1.npi_product_id IS NOT NULL) GROUP BY base_v1.npi_product_id, base_v1.npi_product, base_v1.country ), data_set_d AS ( SELECT a.id, a.npi_product_name, a.product_name_in_sci_pdp, b.npi_product_id, b.npi_region, b.country, b.country_code FROM (dim_product_mapping a LEFT JOIN ( SELECT dim_mapping_region_country_product.npi_product_id, dim_mapping_region_country_product.npi_region, dim_mapping_region_country_product.country, dim_mapping_region_country_product.country_code, row_number() OVER (PARTITION BY dim_mapping_region_country_product.npi_product_id, dim_mapping_region_country_product.npi_region ORDER BY dim_mapping_region_country_product.country_code) AS order_index FROM dim_mapping_region_country_product) b ON ((((a.id)::text = (b.npi_product_id)::text) AND ((b.order_index = 1) OR ((b.order_index > 1) AND (b.country_code IS NOT NULL)))))) ), data_set_e AS ( SELECT a.id, a.npi_product_name, a.product_name_in_sci_pdp, a.npi_product_id, a.npi_region, COALESCE(a.country, b.country) AS country, COALESCE(a.country_code, b.country_code) AS country_code FROM (data_set_d a LEFT JOIN dim_mapping_region_country b ON ((((a.npi_region)::text = (b.region)::text) AND (a.npi_region IS NOT NULL) AND (a.country_code IS NULL)))) ), data_set_f AS ( SELECT DISTINCT data_set_e.id, data_set_e.npi_product_name, data_set_e.product_name_in_sci_pdp FROM data_set_e WHERE ((data_set_e.npi_product_id IS NULL) AND (data_set_e.npi_region IS NULL) AND (data_set_e.country_code IS NULL)) ), data_set_a_sub_b AS ( SELECT a.geo, a.subgeo, a.country, a.product_group, a.brand, a.product_name, a.sm_number, a.sm_description, a.bucket, a.source_code, a.site_id, a.factory, a.pdp_init, a.pdp_final, a.version, a.update_timestamp, a.seller, a.demand_type, a.color, a.mram, a.mrom, a.design_category, a.subbrand, a.batch_number, a.xcvr, a.pss_version, a.npi_product_id, a.npi_product_name FROM (base_v0 a LEFT JOIN base_v1 b ON ((((a.npi_product_id)::text = (b.npi_product_id)::text) AND ((a.product_name)::text = (b.product_name)::text) AND ((a.sm_number)::text = (b.sm_number)::text) AND ((a.country)::text = (b.country)::text) AND ((a.color)::text = (b.color)::text)))) WHERE (b.npi_product_id IS NULL) ), data_set_g AS ( SELECT a.geo, a.subgeo, a.country, a.product_group, a.brand, a.product_name, a.sm_number, a.sm_description, a.bucket, a.source_code, a.site_id, a.factory, a.pdp_init, a.pdp_final, a.version, a.update_timestamp, a.seller, a.demand_type, a.color, a.mram, a.mrom, a.design_category, a.subbrand, a.batch_number, a.xcvr, a.pss_version, a.npi_product_id, a.npi_product_name FROM (data_set_a_sub_b a JOIN data_set_f f ON ((((a.npi_product_id)::text = (f.id)::text) AND ((a.product_name)::text = (f.product_name_in_sci_pdp)::text)))) ), data_set_h AS ( SELECT a.geo, a.subgeo, a.country, a.product_group, a.brand, a.product_name, a.sm_number, a.sm_description, a.bucket, a.source_code, a.site_id, a.factory, a.pdp_init, a.pdp_final, a.version, a.update_timestamp, a.seller, a.demand_type, a.color, a.mram, a.mrom, a.design_category, a.subbrand, a.batch_number, a.xcvr, a.pss_version, a.npi_product_id, a.npi_product_name AS npi_product, b.country AS npi_country, b.region AS npi_region, a.seller AS npi_customer, NULL::text AS npi_color FROM (data_set_g a LEFT JOIN dim_mapping_region_country b ON (((a.country)::text = (b.country_code)::text))) ), data_set_a_sub_h_sub_c AS ( SELECT a.geo, a.subgeo, a.country, a.product_group, a.brand, a.product_name, a.sm_number, a.sm_description, a.bucket, a.source_code, a.site_id, a.factory, a.pdp_init, a.pdp_final, a.version, a.update_timestamp, a.seller, a.demand_type, a.color, a.mram, a.mrom, a.design_category, a.subbrand, a.batch_number, a.xcvr, a.pss_version, a.npi_product_id, a.npi_product_name FROM (( SELECT a_1.geo, a_1.subgeo, a_1.country, a_1.product_group, a_1.brand, a_1.product_name, a_1.sm_number, a_1.sm_description, a_1.bucket, a_1.source_code, a_1.site_id, a_1.factory, a_1.pdp_init, a_1.pdp_final, a_1.version, a_1.update_timestamp, a_1.seller, a_1.demand_type, a_1.color, a_1.mram, a_1.mrom, a_1.design_category, a_1.subbrand, a_1.batch_number, a_1.xcvr, a_1.pss_version, a_1.npi_product_id, a_1.npi_product_name FROM (base_v0 a_1 LEFT JOIN data_set_h h ON ((((a_1.npi_product_id)::text = (h.npi_product_id)::text) AND ((a_1.product_name)::text = (h.product_name)::text) AND ((a_1.sm_number)::text = (h.sm_number)::text) AND ((a_1.country)::text = (h.country)::text) AND ((a_1.color)::text = (h.color)::text)))) WHERE (h.npi_product_id IS NULL)) a LEFT JOIN filter_v1 c ON ((((a.npi_product_id)::text = (c.npi_product_id)::text) AND ((a.country)::text = (c.country)::text)))) WHERE (c.npi_product_id IS NULL) ), data_set_e_sub_f AS ( SELECT e.id, e.npi_product_name, e.product_name_in_sci_pdp, e.npi_product_id, e.npi_region, e.country, e.country_code FROM (data_set_e e LEFT JOIN data_set_f f ON ((((e.id)::text = (f.id)::text) AND ((e.npi_product_name)::text = (f.npi_product_name)::text) AND ((e.product_name_in_sci_pdp)::text = (f.product_name_in_sci_pdp)::text)))) WHERE (f.id IS NULL) ), data_set_k AS ( SELECT a.geo, a.subgeo, a.country, a.product_group, a.brand, a.product_name, a.sm_number, a.sm_description, a.bucket, a.source_code, a.site_id, a.factory, a.pdp_init, a.pdp_final, a.version, a.update_timestamp, a.seller, a.demand_type, a.color, a.mram, a.mrom, a.design_category, a.subbrand, a.batch_number, a.xcvr, a.pss_version, a.npi_product_id, a.npi_product_name AS npi_product, b.country AS npi_country, b.npi_region, a.seller AS npi_customer, NULL::text AS npi_color FROM (data_set_a_sub_h_sub_c a JOIN data_set_e_sub_f b ON ((((a.npi_product_id)::text = (b.id)::text) AND ((a.product_name)::text = (b.product_name_in_sci_pdp)::text) AND ((a.country)::text = (b.country_code)::text)))) ) , v_smart_pss_pdp_customer as( SELECT base_v1.geo, base_v1.subgeo, base_v1.country, base_v1.product_group, base_v1.brand, base_v1.product_name, base_v1.sm_number, base_v1.sm_description, base_v1.bucket, base_v1.source_code, base_v1.site_id, base_v1.factory, base_v1.pdp_init, base_v1.pdp_final, base_v1.version, base_v1.update_timestamp, base_v1.seller, base_v1.demand_type, base_v1.color, base_v1.mram, base_v1.mrom, base_v1.design_category, base_v1.subbrand, base_v1.batch_number, base_v1.xcvr, base_v1.pss_version, base_v1.npi_product_id, base_v1.npi_product, base_v1.npi_country, base_v1.npi_region, base_v1.npi_customer, base_v1.npi_color FROM base_v1 WHERE (base_v1.npi_product_id IS NOT NULL) UNION ALL SELECT data_set_h.geo, data_set_h.subgeo, data_set_h.country, data_set_h.product_group, data_set_h.brand, data_set_h.product_name, data_set_h.sm_number, data_set_h.sm_description, data_set_h.bucket, data_set_h.source_code, data_set_h.site_id, data_set_h.factory, data_set_h.pdp_init, data_set_h.pdp_final, data_set_h.version, data_set_h.update_timestamp, data_set_h.seller, data_set_h.demand_type, data_set_h.color, data_set_h.mram, data_set_h.mrom, data_set_h.design_category, data_set_h.subbrand, data_set_h.batch_number, data_set_h.xcvr, data_set_h.pss_version, data_set_h.npi_product_id, data_set_h.npi_product, data_set_h.npi_country, data_set_h.npi_region, data_set_h.npi_customer, data_set_h.npi_color FROM data_set_h WHERE (data_set_h.npi_product_id IS NOT NULL) UNION ALL SELECT data_set_k.geo, data_set_k.subgeo, data_set_k.country, data_set_k.product_group, data_set_k.brand, data_set_k.product_name, data_set_k.sm_number, data_set_k.sm_description, data_set_k.bucket, data_set_k.source_code, data_set_k.site_id, data_set_k.factory, data_set_k.pdp_init, data_set_k.pdp_final, data_set_k.version, data_set_k.update_timestamp, data_set_k.seller, data_set_k.demand_type, data_set_k.color, data_set_k.mram, data_set_k.mrom, data_set_k.design_category, data_set_k.subbrand, data_set_k.batch_number, data_set_k.xcvr, data_set_k.pss_version, data_set_k.npi_product_id, data_set_k.npi_product, data_set_k.npi_country, data_set_k.npi_region, data_set_k.npi_customer, data_set_k.npi_color FROM data_set_k WHERE (data_set_k.npi_product_id IS NOT NULL) ) , mon_day as( select * from dim_pss_calendar as dpc where dpc.day_of_week=1 ) ,full_and_monday as ( select dpc.date,md.date as mon,md.year,md.quarter,md.month,md.week,extract(day from md.date) as day from dim_pss_calendar as dpc LEFT JOIN mon_day as md on dpc.year=md.year and dpc.week_start=md.week_start and dpc.week=md.week order by date ) ,sep as( select fad.year, fad.quarter, fad.month, fad.week, fad.mon as date, fad.day , npi_product,npi_region,npi_country , pdp_final from v_smart_pss_pdp_customer as spp LEFT JOIN full_and_monday as fad on fad.date::date=bucket::date ORDER BY spp.factory,bucket ) , tem as( SELECT md.date,tr.year,tr.quarter , npi_product,npi_region,npi_country , sum(pdp_final) as pdpFinal FROM sep as tr LEFT JOIN mon_day as md on md.year=tr.year and md.week=tr.week GROUP BY npi_product,npi_region,npi_country , md.date,tr.year,tr.quarter ) ,t_complex as( select npi_product as npi_product_name,npi_region,npi_country as country,'' as npi_customer , json_agg(json_build_object('date',date,'year',year,'quarter',quarter,'value',pdpFinal)) as complex from tem group by npi_product,npi_region,npi_country ORDER BY npi_product,npi_region,npi_country ) , t_factory as( select DISTINCT product,demand_target,demand_region,demand_customer,demand_factory from dim_factory_sourcing_dependency where product in ('DEVON22','ALL') and demand_target in (2,0) ) select demand_factory AS factory,case when dfl.type='EMS' THEN TRUE ELSE FAlse end as ems, npi_product_name,npi_region,country,npi_customer,complex from t_complex as tc left join t_factory as tf on (tc.npi_product_name=tf.product or 'ALL'=tf.product) and tc.npi_region=tf.demand_region left join dim_factory_list as dfl on demand_factory=dfl.factory


